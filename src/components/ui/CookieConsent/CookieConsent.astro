---
// Cookie consent component - Steps 2-7
import type { TranslationObject } from "@utils/serverI18n";

interface Props {
  translations?: TranslationObject;
  currentLang?: string;
}

const { translations, currentLang = 'en' } = Astro.props;
---

<!-- Load vanilla-cookieconsent CSS from CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@3.1.0/dist/cookieconsent.css">

<!-- Root element for cookie consent -->
<div id="cookie-consent-root" data-translations={JSON.stringify(translations?.cookieConsent)} data-lang={currentLang}></div>

<!-- Load vanilla-cookieconsent JS from CDN and wait for it to load -->
<script is:inline>
  // Load the CDN script dynamically to ensure it's available
  (function() {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@3.1.0/dist/cookieconsent.umd.js';
    script.onload = function() {
      // Dispatch custom event when CookieConsent is ready
      window.dispatchEvent(new Event('cookieconsent-loaded'));
    };
    document.head.appendChild(script);
  })();
</script>

<!-- Cookie Consent Initialization - Inlined to ensure it runs in production -->
<script is:inline>
  // EU/EEA countries requiring GDPR opt-in consent
  const EU_COUNTRIES = [
    'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR',
    'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL',
    'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE',
    // EEA countries (not in EU but follow GDPR)
    'IS', 'LI', 'NO',
    // UK (follows GDPR-like regulations)
    'GB'
  ];

  // Get a cookie value by name
  function getCookie(name) {
    if (typeof document === 'undefined') return null;

    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);

    if (parts.length === 2) {
      return parts.pop()?.split(';').shift() || null;
    }

    return null;
  }

  // Get the user's country code from the cookie set by Netlify Edge Function
  function getUserCountry() {
    const country = getCookie('user_country');
    return country || 'UNKNOWN';
  }

  // Check if the user is from an EU/EEA country requiring GDPR consent
  function shouldShowBanner(countryCode) {
    return EU_COUNTRIES.includes(countryCode.toUpperCase());
  }

  // Wait for CookieConsent library to load from CDN (window.CookieConsent will be available)
  function initCookieConsent() {
    const CookieConsent = window.CookieConsent;

    if (!CookieConsent) {
      console.error('[CookieConsent] Library not loaded');
      return;
    }

    // Step 6-7: Read translations and language from data attributes
    const root = document.getElementById('cookie-consent-root');
    const translationsData = root?.dataset.translations;
    const lang = root?.dataset.lang || 'en';
    const t = translationsData ? JSON.parse(translationsData) : null;

    // Step 3: Detect user country
    const userCountry = getUserCountry();
    console.log('[CookieConsent] Step 3: Detected country:', userCountry);

    // Step 4: Check if we should show banner based on country
    const showBanner = shouldShowBanner(userCountry);
    console.log('[CookieConsent] Step 4: Should show banner?', showBanner);

    // Initialize cookie consent for both EU and non-EU users
    // Non-EU: Auto-accept analytics, no banner shown
    // EU: Show banner requiring opt-in
    try {
      CookieConsent.run({
      // Hide consent modal initially for non-EU users
      autoShow: showBanner,

      categories: {
        necessary: {
          enabled: true,  // Always enabled (can't be disabled)
          readOnly: true  // User can't toggle this off
        },
        analytics: {
          // For non-EU: enabled by default (auto-accept)
          // For EU: disabled by default (user must opt-in)
          enabled: !showBanner
        }
      },

    language: {
      default: lang,
      translations: {
        [lang]: t ? {
          consentModal: t.consentModal,
          preferencesModal: t.preferencesModal
        } : {
          // Fallback to hardcoded English if no translations provided
          consentModal: {
            title: 'We use cookies',
            description: 'We use cookies to analyze site traffic with Google Analytics. This helps us understand how visitors use our website so we can improve it. You can accept or reject analytics cookies below.',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            showPreferencesBtn: 'Cookie settings'
          },
          preferencesModal: {
            title: 'Cookie preferences',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            savePreferencesBtn: 'Save my preferences',
            closeIconLabel: 'Close',
            sections: [
              {
                title: 'Cookie usage',
                description: 'We use cookies to ensure the basic functionalities of the website and to enhance your online experience. You can change or withdraw your consent at any time.'
              },
              {
                title: 'Strictly necessary cookies',
                description: 'These cookies are essential for the website to function. They enable core functionality such as language preference. The website cannot function properly without these cookies.',
                linkedCategory: 'necessary'
              },
              {
                title: 'Analytics cookies',
                description: 'These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. We use Google Analytics, which sets cookies like _ga, _ga_*, and _gid to distinguish unique visitors and track usage patterns.',
                linkedCategory: 'analytics'
              }
            ]
          }
        }
      }
    }
    });

    if (showBanner) {
      console.log('[CookieConsent] Step 4: Banner initialized for EU country');
    } else {
      console.log('[CookieConsent] Step 4: Initialized with auto-accept for non-EU country');
    }
  } catch (error) {
    console.error('[CookieConsent] Error initializing CookieConsent:', error);
  }

  console.log('[CookieConsent] Step 2: Component initialized');

  // Sync cookie consent theme with website theme
  function syncCookieConsentTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    if (currentTheme === 'dark') {
      document.documentElement.classList.add('cc--darkmode');
    } else {
      document.documentElement.classList.remove('cc--darkmode');
    }
  }

  // Apply initial theme
  syncCookieConsentTheme();

  // Listen for theme changes from the website's theme toggle
  document.addEventListener('theme:changed', syncCookieConsentTheme);
}

// Listen for the library load event
window.addEventListener('cookieconsent-loaded', initCookieConsent);

// Also try to init immediately in case the library is already loaded
if (window.CookieConsent) {
  initCookieConsent();
}
</script>

<!-- Step 8: Wire footer Cookie Settings button -->
<script>
  import './cookie-consent.client.ts';
</script>

<!-- Step 9: Debug helpers (development only) -->
{import.meta.env.DEV && (
  <script>
    import './debug-helpers.client.ts';
  </script>
)}
