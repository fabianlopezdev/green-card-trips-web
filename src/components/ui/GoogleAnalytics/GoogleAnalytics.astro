---
// Step 5: Google Analytics Integration with Consent Mode v2
const { trackingId } = Astro.props as { trackingId?: string };
if (!trackingId) {
  return null;
}
---

<div id="ga-root" data-tracking-id={trackingId} style="display:none"></div>

<!-- Google Consent Mode v2 Implementation -->
<script is:inline>
  (function() {
    const root = document.getElementById("ga-root");
    const trackingId = root?.dataset.trackingId;

    if (!trackingId) {
      console.log('[GA] No tracking ID provided');
      return;
    }

    console.log('[GA] Initializing Google Consent Mode v2...');

    // Step 1: Initialize dataLayer and gtag BEFORE loading GA
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    window.gtag = gtag;

    // Step 2: Set default consent to 'denied' (GDPR requirement)
    // This MUST happen before loading the GA script
    gtag('consent', 'default', {
      'analytics_storage': 'denied',
      'ad_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
      'functionality_storage': 'denied'
    });

    console.log('[GA] Default consent set to denied (GDPR compliant)');

    // Step 3: Load Google Analytics script (always load, regardless of consent)
    // GA will respect consent mode signals automatically
    const script = document.createElement('script');
    script.async = true;
    script.src = 'https://www.googletagmanager.com/gtag/js?id=' + trackingId;
    document.head.appendChild(script);

    // Step 4: Initialize GA
    gtag('js', new Date());
    gtag('config', trackingId);

    console.log('[GA] Google Analytics loaded with Consent Mode v2');

    // Step 5: Update consent based on user choices
    function updateConsent() {
      const cc = window.CookieConsent;
      if (cc && typeof cc.acceptedCategory === 'function') {
        const analyticsAccepted = cc.acceptedCategory('analytics');

        // Update consent signals based on user choice
        gtag('consent', 'update', {
          'analytics_storage': analyticsAccepted ? 'granted' : 'denied'
        });

        console.log('[GA] Consent updated: analytics_storage = ' + (analyticsAccepted ? 'granted' : 'denied'));
      }
    }

    // Check consent immediately (for non-EU auto-accept)
    updateConsent();

    // Listen for consent changes
    window.addEventListener('cc:onConsent', function() {
      console.log('[GA] Cookie consent given, updating consent mode');
      updateConsent();
    });

    window.addEventListener('cc:onChange', function() {
      console.log('[GA] Cookie consent changed, updating consent mode');
      updateConsent();
    });
  })();
</script>
