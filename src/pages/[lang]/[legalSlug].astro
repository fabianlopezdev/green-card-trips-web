---
import LegalLayout from "@layouts/LegalLayout.astro";
import defaultTemplateConfig from "@utils/config";
import { getTranslations, getSupportedLanguages, legalPageSlugs, type LegalPageKey } from "@utils/serverI18n";
import { generateBreadcrumbSchema } from "@utils/structuredData";
import PrivacyPolicyContent from "@components/legal/PrivacyPolicy.astro";
import TermsAndConditionsContent from "@components/legal/TermsAndConditions.astro";
import { getLegalEntry } from "@utils/getLegalEntry";

export function getStaticPaths() {
  const languages = getSupportedLanguages();
  const paths: any[] = [];

  // Exclude 'en' since English is at root level (/)
  const nonEnglishLangs = languages.filter(lang => lang !== 'en');

  // Generate paths for each legal page in each non-English language
  // Note: cookies-policy is excluded as there's no content for it yet
  const availablePages = ['privacy-policy', 'terms-and-conditions'] as const;

  nonEnglishLangs.forEach(lang => {
    availablePages.forEach(pageKey => {
      const slug = legalPageSlugs[pageKey][lang as keyof typeof legalPageSlugs[typeof pageKey]];
      paths.push({
        params: { lang, legalSlug: slug },
        props: {
          lang,
          pageKey: pageKey as LegalPageKey,
          translations: getTranslations(lang),
        }
      });
    });
  });

  return paths;
}

const { lang, legalSlug } = Astro.params;
const { pageKey, translations } = Astro.props;

const legalEntry = await getLegalEntry(pageKey, lang);
const seo = legalEntry.data.seo;

// Generate site URL for breadcrumbs
const siteUrl = Astro.site || new URL(Astro.url.origin);

const pageTitle = legalEntry.data.title || seo?.title || "";

// Generate breadcrumb schema with language-specific URLs
const breadcrumbs = [
  { name: translations?.navbar?.home || "Home", url: new URL(`/${lang}`, siteUrl).href },
  { name: pageTitle, url: new URL(`/${lang}/${legalSlug}`, siteUrl).href }
];
const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbs);
---

<LegalLayout
  {...defaultTemplateConfig}
  seo={seo}
  currentLang={lang}
  translations={translations}
>
  <!-- BreadcrumbList Structured Data -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} slot="head" />

  {pageKey === 'privacy-policy' && (
    <PrivacyPolicyContent currentLang={lang} />
  )}
  {pageKey === 'terms-and-conditions' && (
    <TermsAndConditionsContent currentLang={lang} />
  )}
</LegalLayout>
